#!/bin/bash -xv
load()
{
echo -n ""
bar="/|\\-/|\\-"
  while :
  do
    for i in `seq 0 7`
    do
      echo -n "${bar:$i:1}"
      echo -en "\010"
      sleep 0.2
    done
  done
}
check_p() #Devuelve una respuesta en funcion del codigo stdout
{
	[ $? = 0 ] && echo -e "\e[32mOk.                         \e[0m $1" || echo -e "\e[91mERROR.                         \e[0m $1"
}
dpkg_solved() #Intenta solventar cualquier problema con la instalacion de algun paquete
{
[ $? != 0 ] && dpkg --configure -a; apt install -f -y; apt autoremove; mv /var/lib/dpkg/info/"${pack/ /}".* /tmp; apt --fix-broken install; apt update; apt install $pack --allow-remove-essential -y;
}
confirm_install() #Confirma la instalacion de las dependencias
{
echo -e "\e[91mPackages needed: \e[93m${falta[@]}\e[0m \e[91m Install? (y/n/e)\e[0m"
read -N1 -s install
	if [ $install = "y" ]
	then
		for pack in "${falta[@]}"
		do
		apt install $pack --allow-remove-essential -y
		dpkg_solved
		done
	config_all
	else
	[ $install = "e" ] && exit
	echo -e "\e[93mWARNING:\e[0m Packages: (${falta[@]/ /}) are missing."
	echo "Starting domain config..."
	config_all
	exit
	fi
}
add() #Comprueba que paquetes estan instalados y cuales faltan para posteriormente almacenarlos y mostrarlos
{
if [ $? != 0 ]
then
        $i=1 > /dev/null 2>&1
	falta+=("$i");
else
        [ $once = "0" ] && echo -e " \e[32mOk\e[0m";
        $i=0 > /dev/null 2>&1
        once=1
fi

}
config_samba() #Configuracion del dominio y rol del equipo
{
	mv /etc/samba/smb.conf /etc/samba/smb.conf.copy > /dev/null 2>&1
	echo -e "\e[32m+========================+\e[0m"
	samba-tool domain provision
	if [ $? != 0 ]; then
		echo -e "\e[91mERROR:\e[0m samba-tool provided an exit code ($?)"
		exit
	else
		echo -e "\e[32m+========================+\e[0m"
		echo "Checking services..."
		echo -e -n "\e[93mSamba... \e[0m"
		mv /var/lib/samba/private/krb5.conf /etc > /dev/null 2>&1
		systemctl stop smbd winbind systemd-resolved > /dev/null 2>&1
		systemctl disable smbd nmbd winbind systemd-resolved > /dev/null 2>&1
		systemctl start samba-ad-dc > /dev/null 2>&1
		systemctl enable samba-ad-dc > /dev/null 2>&1
		systemctl unmask samba-ad-dc > /dev/null 2>&1
		systemctl enable samba-ad-dc > /dev/null 2>&1
		systemctl restart samba-ad-dc > /dev/null 2>&1
		systemctl start samba-ad-dc > /dev/null 2>&1
		load &
		sleep 3
		spin_pid=$!
		{ kill $spin_pid && wait $spin_pid; } 2>/dev/null
		eval
		check_p
	fi
}
config_apache()
{
	echo -e -n "\e[93mApache... \e[0m"
	systemctl start apache2 > /dev/null 2>&1
	systemctl enable apache2 > /dev/null 2>&1
	systemctl status apache2 > /dev/null 2>&1
	load &
	sleep 3
	spin_pid=$!
	{ kill $spin_pid && wait $spin_pid; } 2>/dev/null
	eval #proc ok
	check_p
}
config_ufw() #Configuracion del funcionamiento y estado del firewall
{
	echo -e -n "\e[93mUfw... \e[0m"
	ufw allow 'Apache' > /dev/null 2>&1
	ufw allow 10000/tcp > /dev/null 2>&1
	if [[ `/usr/sbin/ufw status > /dev/null 2>&1 | cut -d":" -f2 | xargs` == "inactive" ]]
	then
	read -N1 -s -p "Firewall (ufw) it's not enabled. Enable it? (y/n)" ufw
	[ $ufw = "y" ] && ufw enable > /dev/null 2>&1; check_p;
	else
	load &
	sleep 3
	spin_pid=$!
	{ kill $spin_pid && wait $spin_pid; } 2>/dev/null
	eval #proc ok
	check_p
	fi
}
config_network()
{
	echo -e -n "\e[93mNetwork... \e[0m"
	read -N1 -s -p "Change network config? (y/n) " change_net

		if [ $change_net = "y" ]; then
			for target in ${interfaces[@]}
			do
			echo $target
				if [ {ps aux | grep -v grep | awk '{print $11}' | grep $target} ]; then
					if [ $target = "NetworkManager" ] && [ $net_f = 0 ]; then net_interfaces; $((net_f++));fi
					#if [ $target = "Networkd" ] && [ $net_f = 0 ]; then net_netplan; $((net_f++));fi
				else echo $((net_nf++)) > /dev/null 2>&1
				fi
			done
			[ "$net_nf" = "${#interfaces[@]}" ] && echo -e "\e[91mERROR:\e[0m Network target not found x$$, changing default..."; net_interfaces
		else echo -e -n "\r\e[93mNetwork...                                      \e[0m"
		     echo -e -n "\r\e[93mNetwork...  \e[0m"
		     load &
		     sleep 3
		     spin_pid=$!
		     { kill $spin_pid && wait $spin_pid; } 2>/dev/null
		     eval #proc ok
		     check_p
		fi
}
net_interfaces()
{
echo -e "#Uncomment lines below for enable it\n\n#Loopback network\n#auto lo\n#iface lo inet loopback\n\n#Primary network\n#allow-hotplug enp0s3\n#iface enp0s3 inet dhcp\n\n" > /etc/network/interfaces
net=("target" \ "ip" \ "network" \ "netmask")
read -p "NÂº Targets: " n_target
for (( c=1; c<=$n_target; c++ ))
do
	for i in ${net[@]}
	do
	read -p "$i: " $i
	done
	echo -e "auto $target\niface $target inet static\naddress $ip\n\nnetmask $netmask\n\nnetwork $network" >> /etc/network/interfaces
done
nano /etc/network/interfaces
/etc/init.d/NetworkManager restart > /dev/null 2>&1
/etc/init.d/networking.service > /dev/null 2>&1
/usr/sbin/dhclient > /dev/null 2>&1
check_p
}
net_netplan()
{
eval
}
config_all()
{
	config_samba
	config_apache
	config_ufw
	config_network
}
clean_stat()
{
echo -e "\r                                                                                "
}
config_structure()
{
echo -e -n "\e[93mGenerating structure... \e[0m"
load &
spin_pid=$!
	#usuarios
	for u in ${users[@]}
	do
	/usr/sbin/useradd u -p 12345abcd.
	
	done
{ kill $spin_pid && wait $spin_pid; } 2>/dev/null
}

[ "$UID" != "0" ] && echo -e "\e[93mWARNING:\e[0m It's recomended to execute as root to prevent any error." && exit
	# Array con los paquetes necesarios para todo el proceso
	packages=("samba" \ "smbclient" \ "winbind" \ "apache2" \ "ufw" \ "webmin" \ "wget" \ "openssl" \ "perl" \ "krb5-config" \ "ntp" )
	interfaces=("NetworkManager" \ "Networkd")
	users=("sol" \ "mon" \ "tom" \ "pia" \ "paz" \ "noe")
	net_nf=0
	net_f=0
	once=0
	if [ -z $1 ]; then
	grep "deb http://download.webmin.com/download/repository sarge contrib" /etc/apt/sources.list > /dev/null 2>&1
		if [ $? != 0 ]; then
		echo -n -e "\rModifying apt resources...  "
		load &
		spin_pid=$!
		sleep .8
		echo "deb http://download.webmin.com/download/repository sarge contrib" >> /etc/apt/sources.list
		{ kill $spin_pid && wait $spin_pid; } 2>/dev/null
		echo -n -e "\rLoading rep from archive.ubuntu.com...  "
		load &
		spin_pid=$!
		wget http://www.webmin.com/jcameron-key.asc > /dev/null 2>&1
		apt-key add jcameron-key.asc > /dev/null 2>&1
		apt update > /dev/null 2>&1
		rm jcameron-key.asc > /dev/null 2>&1
		{ kill $spin_pid && wait $spin_pid; } 2>/dev/null
		fi
	# Comprueba las dependencias
	echo -e -n "\rChecking resources dependencies...  "
		for i in "${packages[@]}"
		do
		dpkg -s $i > /dev/null 2>&1
			add
		sleep 0.2
		done
	[ "${falta}" != "" ] && confirm_install || config_all
	else
	invalid_in1="\e[91mERROR:\e[0m Invalid argument ($1)"
	invalid_in2="\e[91mERROR:\e[0m Invalid argument ($2)"
	missing="\e[91mERROR:\e[0m One or more arguments are missing"
		case $1 in
		user)	case $2 in
			create);;
			add);;
			delete);;
			"")echo -e $missing;;
			*)echo -e $invalid_in2;;
			esac;;
		time);;
		-p)config_$2;;
		"")echo -e $missing;;
		*)echo -e $invalid_in1;;
		esac

fi
